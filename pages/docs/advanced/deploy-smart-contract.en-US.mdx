import Deploy from 'components/example/deploy-smart-contract'
import Callout from "nextra-theme-docs/callout";

# Deploy Contract

## Simple Summary

An RPC method for allowing users to deploy a new smart contract to TON network. `ton_deployContract` RPC method allow to do it.

This use case can be used in a variety of ways. DApp developers may offer to wallet owners to deploy their personal contracts.
It may be a useful feature in allowing the to owner store and get information in the contract.
Or it may be an option to deploy an NFT contract, to reward users after completing a tutorial or course.

## Tutorial

<Callout>The tutorial can run in `mainnet` and `testnet` networks.<br />OpenMask team recommends using `testnet`.</Callout>

For example, we deploy smart contracts from [tonstarter-contracts](https://github.com/ton-defi-org/tonstarter-contracts) template.

The full source code you may find by this [link](https://github.com/ton-defi-org/tonstarter-contracts/blob/main/contracts/main.fc).

### Overview

The smart contract contains cell data with store `counter` and `owner_address` and contracts public methods to retrieve this data from a contract.
All of this makes this contract suit well for this tutorial.

```
(slice, int) load_data() inline {
  var ds = get_data().begin_parse();
  return (
    ds~load_msg_addr(), ;; owner_address
    ds~load_uint(64)    ;; counter
  );
}

---------------

slice owner_address() method_id {
  var (owner_address, _) = load_data();
  return owner_address;
}

int counter() method_id {
  var (_, counter) = load_data();
  return counter;
}
```

### Build smart contract

To build this smart contract you may download the repository, install dependencies as notes in `README.md` and run the command `npm run build`.

As a result in the file `build/main.compiled.json` you may find a build for this smart contract. If you don't touch the source in `main.fc` file it would be the same.

```json
{"hex":"b5ee9c72c1020f01000109000000000d00120017001c0023002800360040004e0053006c0071008701040114ff00f4a413f4bcf2c80b010201620902020120080302014805040009b59f10055002015807060017ad0c76a2687d20699f9818c0000faf607c13b79118400017bffecf6a2687d20699f981840202cd0b0a002dd7c13b7911829815f797033c1044c4b4050895b047800c0201480d0c00271c20063232c15400f3c5807e80b2dab25cfec02001f30cb434c0fe900c005c6c2456f83b51343e9034cfcc00f4c7f4cfcc4860840dd247cbeea7c408d7c0c069321633c5b2cff27b553808608411f550e46ea497c1780860841060da602ea7cc4cd9b1c17cb819807e800c007c01380060840b68e2abeea384d671c17cb819be900c00721633c5b2cff27b553817c1200e0006f2c065ea043d88"}
```

### Create initial data and message

For deploying the process the contract developer if required has to provide initial data which would be stored in the smart contract cell and also the initial message with will be run with the deploy transaction.

For this smart contract, initial data is a cell with initial `counter` and initial `owner_address` values.

To build the initial data cell we could use TON js client library from tonwhales - [ton](https://www.npmjs.com/package/ton) package.

The following function will create a cell and store `address` and `int64` counter values and format it as a boc string.

```js
const getInitData = (ownerAddress, counter) => {
  return beginCell()
    .storeAddress(Address.parseFriendly(ownerAddress).address)
    .storeUint(counter, 64)
    .endCell()
    .toBoc()
    .toString("hex");
};
```

The following function will create an initial message with execute on the deploy transaction.
The example contract handles a few different messages. This message would run the code with an increment counter and store the new value.

```js
const getInitMessage = () => {
  return beginCell()
    .storeUint(0x37491f2f, 32)
    .storeUint(0, 64)
    .endCell()
    .toBoc()
    .toString("hex");
};
```

### Result

`ton_deployContract` RPC method have paramters:

```ts
interface DeployParams {
    // Smart contract code boc string
    initCodeCell: string;
    // Smart contract initial data boc string
    initDataCell: string;
    // Initial mesasge boc string (optional)
    initMessageCell?: string;
    // Amount to funding smart contract in nanotons, to pay network and storage fee
    amount: string;
}
```

And all together, the code will deploy a smart contract:

```jsx
import { useState } from "react";
import { beginCell, Address } from "ton";

const initCode =
  "b5ee9c72c1020f01000109000000000d00120017001c0023002800360040004e0053006c0071008701040114ff00f4a413f4bcf2c80b010201620902020120080302014805040009b59f10055002015807060017ad0c76a2687d20699f9818c0000faf607c13b79118400017bffecf6a2687d20699f981840202cd0b0a002dd7c13b7911829815f797033c1044c4b4050895b047800c0201480d0c00271c20063232c15400f3c5807e80b2dab25cfec02001f30cb434c0fe900c005c6c2456f83b51343e9034cfcc00f4c7f4cfcc4860840dd247cbeea7c408d7c0c069321633c5b2cff27b553808608411f550e46ea497c1780860841060da602ea7cc4cd9b1c17cb819807e800c007c01380060840b68e2abeea384d671c17cb819be900c00721633c5b2cff27b553817c1200e0006f2c065ea043d88";

const getInitData = (ownerAddress, counter) => {
  return beginCell()
    .storeAddress(Address.parseFriendly(ownerAddress).address)
    .storeUint(counter, 64)
    .endCell()
    .toBoc()
    .toString("hex");
};

const getInitMessage = () => {
  return beginCell()
    .storeUint(0x37491f2f, 32)
    .storeUint(0, 64)
    .endCell()
    .toBoc()
    .toString("hex");
};

export default () => {
  const [disabled, setDisabled] = useState(false);
  const [isSent, setSent] = useState(false);
  const [isConfirm, setConfirm] = useState(false);
  const [address, setAddress] = useState("");

  const send = async () => {
    const provider = window.ton;
    setSent(false);
    setConfirm(false);

    setDisabled(true);
    try {
      const [ownerAddress] = await provider.send("ton_requestAccounts");

      const { walletSeqNo, newContractAddress } = await provider.send(
        "ton_deployContract",
        [
          {
            initCodeCell: initCode,
            initDataCell: getInitData(ownerAddress, 20),
            initMessageCell: getInitMessage(),
            amount: "50000000", // 0.05 TON
          },
          ownerAddress,
        ]
      );
      setSent(true);
      await provider.send("ton_confirmWalletSeqNo", [walletSeqNo, ownerAddress]);

      setAddress(newContractAddress);
      setConfirm(true);
    } catch (e) {
      console.error(e);
    } finally {
      setDisabled(false);
    }
  };

  return (
    <div className="py-8">
      <button disabled={disabled} onClick={send}>
        Deploy Smart Contract
      </button>
      {isSent && (
        <div>
          {isConfirm
            ? "Done. New contract address: " + address
            : "Deploy Pending... ~15 sec"}
        </div>
      )}
    </div>
  );
};
```

## Finishing touch

After deployment, we would like to test the smart contract that it works.
You may use [ton](https://www.npmjs.com/package/ton) package to handle it. For example like this.

```jsx

const CheckResult = ({ address }) => {
  const network = useNetwork();

  const [counter, setCounter] = useState("");
  const [owner, setOwner] = useState("");

  const client = useMemo(() => {
    const endpoint =
      network === "mainnet"
        ? "https://toncenter.com/api/v2/jsonRPC"
        : "https://testnet.toncenter.com/api/v2/jsonRPC";

    // The client withour api key have a limitaion in 1 request set second,
    // please don't click buttons to offten
    return new TonClient({ endpoint });
  }, [network]);

  const getCounter = async () => {
    const call = await client.callGetMethod(address, "counter");
    const counter = new TupleSlice(call.stack).readBigNumber();
    setCounter(counter.toString());
  };

  const getOwner = async () => {
    const call = await client.callGetMethod(address, "counter");
    const owner = new TupleSlice(call.stack).readNumericAddress(0);
    setOwner(owner.toString());
  };

  return (
    <>
      <button onClick={getCounter}>
        Get Counter
      </button>
      {counter && <div>{counter}</div>}
      <button onClick={getOwner}>
        Get contract owner
      </button>
      {owner && <div>{owner}</div>}
    </>
  );
};

```

<Deploy />
